#include <stdio.h>
#include <math.h>
#include "battery_model.h"


double temp_lut[TEMP_COUNT] = {-5.00, 0.00, 10.00, 20.00, 30.00, 40.00, 50.00};

double soc_lut[SOC_COUNT] = {
    0.00, 0.05, 0.10, 0.15, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 
    0.80, 0.85, 0.90, 0.95, 1.00
};

double F_R0[TEMP_COUNT][SOC_COUNT] = {
    {0.218014997383328, 0.170188793575381, 0.189014322145870, 0.206399935240328, 0.221246401786206,
     0.170737374280710, 0.172924167502551, 0.160273078591468, 0.165426689980338, 0.159004893697639,
     0.170669375136920, 0.194673271551785, 0.166920070423618, 0.175408243851610, 0.0352455859683125},

    {0.146869956995078, 0.139686026351630, 0.150461934825179, 0.159453302166371, 0.166140555470319,
     0.119189515947820, 0.132520601549243, 0.136434833117796, 0.153428641970846, 0.173132974335377,
     0.184690509488282, 0.174000529436231, 0.129167189418648, 0.149116280740132, 0.275440805531522},

    {0.159576250302593, 0.116940503810066, 0.0163015898374321, 0.121068003306981, 0.159036562522682,
     0.159555182161272, 0.0925221172302271, 0.0156488537978269, 0.0148831101287730, 0.145518740547350,
     0.159997485111873, 0.151422396377450, 0.129111070773131, 0.0846711685533178, 0.0493934231661006},

    {0.153715148879007, 0.0331609974410752, 0.120829501465876, 0.100507515883785, 0.148260463457260,
     0.0297231733868007, 0.0202631871248695, 0.0150930725784726, 0.135165236622724, 0.158170783686989,
     0.126640377596635, 0.108286875768298, 0.0158845617636442, 0.0302386987983394, 0.0256250887921055},

    {0.0837300666802872, 0.0837883030333665, 0.0846279844377994, 0.0813664073668943, 0.0807005086527511,
     0.0816928397091055, 0.0855000208077294, 0.0607514744530299, 0.0486521294843904, 0.292495089635836,
     0.225654705667066, 0.0816230032487570, 0.0865492981738873, 0.0920863227648771, 0.0983159101630010},

    {0.0660322354379656, 0.0701022322972199, 0.0638104968686187, 0.0646966741561114, 0.0694319808546848,
     0.0668991738074492, 0.0614301417502337, 0.0596361323556861, 0.0589151146379141, 0.0605981780878527,
     0.0651735204905620, 0.0630383880399465, 0.0681836419254294, 0.172719546874795, 0.174367352625582},

    {0.145562377350365, 0.0660322354379656, 0.0701022322972199, 0.0638104968686187, 0.0646966741561114,
     0.0694319808546848, 0.0668991738074492, 0.0614301417502337, 0.0596361323556861, 0.0589151146379141,
     0.0605981780878527, 0.0651735204905620, 0.0630383880399465, 0.0681836419254294, 0.172719546874795}
};

double F_R1[TEMP_COUNT][SOC_COUNT] = {
    {0.0742447823755796, 0.00442088304955144, 0.0185415839955120, 0.0215596963404750, 0.0166604740643074,
     0.0172377000330578, 0.0117352080276359, 0.0222201300332516, 0.0252135141365362, 0.0258398786400494,
     0.0210503014971455, 0.0253679108841289, 0.0138433117369743, 0.0152742050988018, 0.491325679716491},

    {0.0482949219796638, 0.0105126740721481, 0.0153295893966471, 0.00832952138293079, 0.0263029702543686,
     0.0284684801451864, 0.00638416981387263, 0.0171701197289630, 0.0221147098955852, 0.0197407411616073,
     0.0250586062613503, 0.00111440259823350, 0.103912568525366, 0.00104438563952487, 0.596439632704612},

    {0.0119340862550856, 0.00945094147684991, 0.0134166103625229, 0.0184650497635990, 0.0193241177269256,
     0.0162027163671101, 0.00994442757345572, 0.0117911061530322, 0.0186401071230704, 0.0228226090882439,
     0.0182284546260199, 0.0261068797562091, 0.0405057361753832, 0.00170298596173230, 0.114151093789489},

    {0.0835426945585762, 0.0151868390608543, 0.0154503680493682, 0.0361631597943570, 0.0149983058890549,
     0.0166753736891251, 0.0175313751317512, 0.0417541375345283, 0.0389140376457371, 0.0190534663861073,
     0.0253013468244225, 0.0215563244888824, 0.0385231016303691, 0.0118993545439219, 0.338791422293798},

    {0.0218086539175103, 0.0445861567752942, 0.0442030356397515, 0.0516484025208661, 0.0208860166799970,
     0.0354069145592746, 0.0370380731687322, 0.0400381713345566, 0.0205597991517630, 0.0511024355228117,
     0.0361408928605803, 0.0826852217334327, 0.0860499558255374, 0.0691820596094026, 0.171894637041508},

    {0.0338842563520309, 0.0522881972303801, 0.0423531515873983, 0.0366102547912826, 0.0469852734703037,
     0.0724642824625453, 0.0646436783459427, 0.0690570145464900, 0.0526664418335744, 0.0645455159570524,
     0.0870162088914598, 0.0762321456474840, 0.0997896733216966, 0.0999946979791169, 0.0999955836851582},

    {0.0600218027659302, 0.0530498035236342, 0.0987254083359931, 0.0877934949035707, 0.0495455472446104,
     0.0646978899945192, 0.0729323070543407, 0.0288597751706007, 0.0478829816868589, 0.0508470460491420,
     0.0556966986146522, 0.127517683415660, 0.104162686621032, 0.169402031772242, 0.538373858039366}
};

double F_C1[TEMP_COUNT][SOC_COUNT] = {
    {154.859111904332, 150.512864900896, 159.859411839016, 159.999892416687, 156.037395933619,
     25.7817763964077, 22.3504839192248, 100.837561164172, 141.757592510957, 159.942932590172,
     159.855804765479, 159.695521993706, 25.2896981344067, 32.8408824098650, 135.001755765634},

    {24.5914382983954, 42.3196571656439, 50.3321928210641, 69.3442758483601, 65.7091665553678,
     12.6268481906144, 17.7981859150985, 19.4439030748274, 46.1266503851253, 62.4259186632772,
     43.5584551498752, 99.2484279769396, 7.45831427358726, 57.1406864996311, 99.9999731350437},

    {49.3934231661006, 84.6711685533178, 129.111070773131, 151.422396377450, 159.997485111873,
     145.518740547350, 14.8831101287730, 15.6488537978269, 92.5221172302271, 159.555182161272,
     159.036562522682, 121.068003306981, 16.3015898374321, 116.940503810066, 159.576250302593},

    {30.2386987983394, 15.8845617636442, 108.286875768298, 126.640377596635, 158.170783686989,
     135.165236622724, 15.0930725784726, 20.2631871248695, 29.7231733868007, 148.260463457260,
     100.507515883785, 120.829501465876, 33.1609974410752, 153.715148879007, 159.995419091354},

    {35.9309051381541, 21.2462769346619, 32.5486522942824, 25.9832276098511, 31.3735479434801,
     23.5642256351255, 15.1383076468384, 25.6250887921055, 24.6570456638238, 26.0224129014491,
     15.0093484597931, 18.1731912387840, 28.5404974389854, 99.7656589172874, 43.5631223603728},

    {46.6256112348051, 46.5265827083189, 48.1300113328845, 49.7914444694561, 58.5021669501755,
     74.0110151277025, 41.3896401937084, 48.1102478209868, 52.2382675938651, 48.3003365186856,
     42.4115660996193, 62.2441306583926, 18.0544261962811, 144.395702015298, 15.2091281562748},

    {56.9694591506516, 20.5448996593085, 67.9630072430476, 32.7423774848244, 25.7822087537857,
     39.9989397093462, 26.3692501477105, 28.9891113286037, 29.2664075668463, 23.4984577404670,
     15.2413581717301, 29.5987918547074, 28.7142877175909, 149.311346901119, 15.0957085739252}
};


double soc_ocv[7]={-8.811549668179980,45.679529345416600,-80.811080705268810,65.685192982219460,-26.145838136551845,4.927980595059218,2.911718336029812};

double d_soc_ocv[6]={-52.869298009079884,2.283976467270830e+02,-3.232443228210752e+02,1.970555789466584e+02,-52.291676273103690,4.927980595059218};

double interpolate(double x1, double y1, double x2, double y2, double x) {
    return y1 + ((y2 - y1) / (x2 - x1)) * (x - x1);
}

void find_nearest_neighbors(double T, double SOC, int *i1, int *i2, int *j1, int *j2) {
    for (int i = 0; i < TEMP_COUNT - 1; i++) {
        if (temp_lut[i] <= T && T < temp_lut[i + 1]) {
            *i1 = i;
            *i2 = i + 1;
            break;
        }
    }
    
    for (int j = 0; j < SOC_COUNT - 1; j++) {
        if (soc_lut[j] <= SOC && SOC < soc_lut[j + 1]) {
            *j1 = j;
            *j2 = j + 1;
            break;
        }
    }
}


double find_value(double temperature, double soc, 
                   double *temp_vector,
                   double *soc_vector,
                   double values_lut[TEMP_COUNT][SOC_COUNT]) {
    int i1 = 0, i2 = TEMP_COUNT - 1;
    int j1 = 0, j2 = SOC_COUNT - 1;

    find_nearest_neighbors(temperature, soc, &i1, &i2, &j1, &j2);

    double T1 = temp_vector[i1], T2 = temp_vector[i2];
    double SOC1 = soc_vector[j1], SOC2 = soc_vector[j2];

    double Q11 = values_lut[i1][j1]; 
    double Q12 = values_lut[i1][j2]; 
    double Q21 = values_lut[i2][j1]; 
    double Q22 = values_lut[i2][j2]; 

    double f_T1 = ((SOC2 - soc) / (SOC2 - SOC1)) * Q11 + ((soc - SOC1) / (SOC2 - SOC1)) * Q12;
    double f_T2 = ((SOC2 - soc) / (SOC2 - SOC1)) * Q21 + ((soc - SOC1) / (SOC2 - SOC1)) * Q22;
    double result = ((T2 - temperature) / (T2 - T1)) * f_T1 + ((temperature - T1) / (T2 - T1)) * f_T2;

    return result;
}



double polyval(double *coefficients, int num_coeffs, double x) {
    double result = 0.0;

    for (int i = 0; i < num_coeffs; i++) {
        result += coefficients[i] * pow(x, num_coeffs - 1 - i);
    }

    return result;
}

void battery_model(double i, double V1, double T, double SOC, double Nc, 
           double A[2][2], double b[2][1], double c[1][2], double *Vt) {
    

    double deltaT = 1;
    double qn   = Nc * 3600;

    double r0 = find_value(T, SOC, temp_lut, soc_lut, F_R0);
    double c1 = find_value(T, SOC, temp_lut, soc_lut, F_C1);
    double r1 = find_value(T, SOC, temp_lut, soc_lut, F_R1);

    double u1 = c1*r1;

    double voc=polyval(soc_ocv,7,SOC);

    double dOCV=polyval(d_soc_ocv,6,SOC);

    double a1 = exp(-deltaT / u1);
    double b1 = r1 * (1 - exp(-deltaT / u1));

    *Vt = voc - r0 * i - V1;

    double eta;
    if (i > 0) {
        eta = 1.0;  
    } else{
        eta = 0.998; 
    }

    
    A[0][0] = 1; 
    A[0][1] = 0; 
    A[1][0] = 0;
    A[1][1] = a1;
    
    b[0][0] = -(eta*deltaT/qn); 
    b[1][0] = b1;
    
    c[0][0] = dOCV;
    c[0][1] = -1;
    
}